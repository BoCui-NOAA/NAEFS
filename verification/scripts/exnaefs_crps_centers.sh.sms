
########################### BIASUPDATE ####################################
echo "------------------------------------------------------------------"
echo "This is ensemble verification program for NAEFS 1 degree products"
echo "------------------------------------------------------------------"
echo "AUTHOR: Bo Cui  (wx20cb)"
########################### BIASUPDATE ####################################

### need pass the values of PDY, CYC, DATA, COMIN, and COMOUT

#CDATE=2011092100

#export runini=YES  

#IFNCEP=YES
#IFCMC=YES
#IFECMWF=YES

ifncep=0
ifcmc=0
ifecmwf=0

if [ "$IFNCEP" = "YES" ]; then ifncep=1; fi
if [ "$IFCMC" = "YES" ]; then ifcmc=1; fi
if [ "$IFECMWF" = "YES" ]; then ifecmwf=1; fi

ifdebias_cmc=0
ifdebias_ecmwf=0

if [ "$IFDEBIAS_CMC" = "YES" ]; then ifdebias_cmc=1; fi
if [ "$IFDEBIAS_ECMWF" = "YES" ]; then ifdebias_ecmwf=1; fi

###    
################################################################
# define exec variable, and entry grib utility 
################################################################
###    

HOMESH=/sss/emc/ensemble/shared/Bo.Cui
export EXECVERF=/gpfs/gd1/emc/ensemble/save/Bo.Cui/ECMWF/exec
export EXECUTIL=/nwprod/util/exec
export NDATE=/nwprod/util/exec/ndate
export COPYGB=$EXECUTIL/copygb

id1=gefs
id2=cmce
id3=ecmwf

px1=
px2=cmc_
px3=ecmwf_

if [ "$ENSIM" = "20s" -o "$ENSIM" = "20x" ]; then
   ex=
elif [ "$ENSIM" = "NC40raw" ]; then
   ex=
elif [ "$ENSIM" = "NCE60raw" ]; then
   ex=
elif [ "$ENSIM" = "ecmwf" ]; then
   ex=
elif [ "$ENSIM" = "ecmwf_bc" ]; then
   ex=_bc
elif [ "$ENSIM" = "NC40bc" ]; then
   ex=_bc
elif [ "$ENSIM" = "NCE60bc" ]; then
   ex=_bc
else
   ex=_bc
fi

mkdir -m 775 -p ${COMOUT}

mkdir -m 775 -p $DATA
rm $DATA/*
cd $DATA

export pgm=crps_from_more_avgspr  
export pgmout=output          
#. prep_step

###########################

export PDY=`echo $CDATE | cut -c1-8`
export cyc=`echo $CDATE | cut -c9-10`


#cp /nwprod/util/ush/setup.sh .
#cp /nwprod/util/ush/setpdy.sh .

#sh setup.sh
#sh setpdy.sh
#. PDY

###################################
### set up hourlist & variable list
###################################

export hourlist=" 00  06  12  18  24  30  36  42  48  54  60  66  72  78  84  90  96 \
                 102 108 114 120 126 132 138 144 150 156 162 168 174 180 186 192 198 \
                 204 210 216 222 228 234 240 246 252 258 264 270 276 282 288 294 300 \
                 306 312 318 324 330 336 342 348 354 360 366 372 378 384"

#########################
### set up  variable list
#########################

fieldlist=" 1000HGT 925HGT 850HGT 700HGT 500HGT 250HGT 200HGT 100HGT 50HGT 10HGT \
            1000TMP 925TMP 850TMP 700TMP 500TMP 250TMP 200TMP 100TMP 50TMP 10TMP \
            1000UGRD 925UGRD 850UGRD 700UGRD 500UGRD 250UGRD 200UGRD 100UGRD 50UGRD 10UGRD \
            1000VGRD 925VGRD 850VGRD 700VGRD 500VGRD 250VGRD 200VGRD 100VGRD 50VGRD 10VGRD \
            PRES PRMSL 2MTMP 10MUGRD 10MVGRD TMAX TMIN 850VVEL DPT2M "

fieldlist=" 2MTMP 10MUGRD 10MVGRD 850TMP PRES PRMSL TMAX TMIN RH2M "

fieldlist=" 2MTMP 10MUGRD 10MVGRD 1000HGT 500HGT 850TMP "

fieldlist=" 2MTMP 10MUGRD 10MVGRD "

#export hourlist=" 24 "

################################
### Set up the region parameters
################################

cat <<paraEOF >input.domlist
&domlist
 ictl=1,la1=11,la2=70,lo1=1,lo2=360,
/
&domlist
 ictl=1,la1=110,la2=170,lo1=1,lo2=360,
/
&domlist
 ictl=1,la1=70,la2=110,lo1=1,lo2=360,
/
&domlist
 ictl=1,la1=30,la2=70,lo1=220,lo2=315,
/
&domlist
 ictl=1,la1=11,la2=60,lo1=1,lo2=45,
/
&domlist
 ictl=1,la1=11,la2=80,lo1=45,lo2=140,
/
paraEOF

########################################################
# input basic information, member and forecast lead time
########################################################

for cfield in $fieldlist; do

  ffd=dummy

  case $cfield in

  1000HGT) ffd=z1000;ifd=7;isp=100;ilv=1000;;
   925HGT) ffd=z925;ifd=7;isp=100;ilv=925;;
   850HGT) ffd=z850;ifd=7;isp=100;ilv=850;;
   700HGT) ffd=z700;ifd=7;isp=100;ilv=700;;
   500HGT) ffd=z500;ifd=7;isp=100;ilv=500;;
   250HGT) ffd=z250;ifd=7;isp=100;ilv=250;;
   200HGT) ffd=z200;ifd=7;isp=100;ilv=200;;
   100HGT) ffd=z100;ifd=7;isp=100;ilv=100;;
    50HGT) ffd=z50; ifd=7;isp=100;ilv=50;;
    10HGT) ffd=z10; ifd=7;isp=100;ilv=10;;

  1000TMP) ffd=t1000;ifd=11;isp=100;ilv=1000;;
   925TMP) ffd=t925;ifd=11;isp=100;ilv=925;;
   850TMP) ffd=t850;ifd=11;isp=100;ilv=850;;
   700TMP) ffd=t700;ifd=11;isp=100;ilv=700;;
   500TMP) ffd=t500;ifd=11;isp=100;ilv=500;;
   250TMP) ffd=t250;ifd=11;isp=100;ilv=250;;
   200TMP) ffd=t200;ifd=11;isp=100;ilv=200;;
   100TMP) ffd=t100;ifd=11;isp=100;ilv=100;;
    50TMP) ffd=t50; ifd=11;isp=100;ilv=50;; 
    10TMP) ffd=t10; ifd=11;isp=100;ilv=10;;

  1000UGRD) ffd=u1000;ifd=33;isp=100;ilv=1000;;
   925UGRD) ffd=u925;ifd=33;isp=100;ilv=925;;
   850UGRD) ffd=u850;ifd=33;isp=100;ilv=850;;
   700UGRD) ffd=u700;ifd=33;isp=100;ilv=700;;
   500UGRD) ffd=u500;ifd=33;isp=100;ilv=500;;
   250UGRD) ffd=u250;ifd=33;isp=100;ilv=250;;
   200UGRD) ffd=u200;ifd=33;isp=100;ilv=200;;
   100UGRD) ffd=u100;ifd=33;isp=100;ilv=100;;
    50UGRD) ffd=u50; ifd=33;isp=100;ilv=50;; 
    10UGRD) ffd=u10; ifd=33;isp=100;ilv=10;;

  1000VGRD) ffd=v1000;ifd=34;isp=100;ilv=1000;;
   925VGRD) ffd=v925;ifd=34;isp=100;ilv=925;;
   850VGRD) ffd=v850;ifd=34;isp=100;ilv=850;;
   700VGRD) ffd=v700;ifd=34;isp=100;ilv=700;;
   500VGRD) ffd=v500;ifd=34;isp=100;ilv=500;;
   250VGRD) ffd=v250;ifd=34;isp=100;ilv=250;;
   200VGRD) ffd=v200;ifd=34;isp=100;ilv=200;;
   100VGRD) ffd=v100;ifd=34;isp=100;ilv=100;;
    50VGRD) ffd=v50; ifd=34;isp=100;ilv=50;; 
    10VGRD) ffd=v10; ifd=34;isp=100;ilv=10;;

    PRMSL) ffd=prmsl;ifd=2;isp=102;ilv=0;;
     PRES) ffd=pres;ifd=1;isp=1;  ilv=0;;
    2MTMP) ffd=t2m;ifd=11;isp=105;ilv=2;;
     TMAX) ffd=t2max;ifd=15;isp=105;ilv=2;;
     TMIN) ffd=t2min;ifd=16;isp=105;ilv=2;;
  10MUGRD) ffd=u10m;ifd=33;isp=105;ilv=10;;
  10MVGRD) ffd=v10m;ifd=34;isp=105;ilv=10;;
  850VVEL) ffd=vvel;ifd=39;isp=100;ilv=850;;
  ULWRFtop) ffd=ulwrftop;ifd=212;isp=8;ilv=0;;
  ULWRFsfc) ffd=ulwrfsfc;ifd=212;isp=1;ilv=0;;
  DPT2M)   ffd=dpt2m;ifd=17;isp=105;ilv=2;;
  RH2M)    ffd=rh2m;ifd=52;isp=105;ilv=2;;

  esac

  if [ "$ffd" == "dummy" ]; then
    echo " #### attention: variable $cfield is not in the list"
  else
    echo " &varlist" >>namin.varlist.$cfield
    echo "pds5=$ifd,pds6=$isp,pds7=$ilv," >>namin.varlist.$cfield
  fi

  echo " /" >>namin.varlist.$cfield

####################
# start verification
####################

for nfhrs in $hourlist; do

###
# ncep gefs analysis files entry
###

  if [ "$runini" = "YES" ]; then

    aymdh=`$NDATE +$nfhrs $CDATE `
    aymd=`echo $aymdh | cut -c1-8`
    amd=`echo $aymdh | cut -c5-8`
    acyc=`echo $aymdh | cut -c9-10`

    fymdh=$CDATE
    fymd=`echo $fymdh | cut -c1-8`
    fcyc=`echo $fymdh | cut -c9-10`

    aymdh_m06=`$NDATE -06 $aymdh `
    aymd_m06=`echo $aymdh_m06 | cut -c1-8`
    amd_m06=`echo $aymdh_m06 | cut -c5-8`
    acyc_m06=`echo $aymdh_m06 | cut -c9-10`

  else
 
    aymdh=$CDATE                            
    aymd=`echo $aymdh | cut -c1-8`
    amd=`echo $aymdh | cut -c5-8`
    acyc=`echo $aymdh | cut -c9-10`

    fymdh=`$NDATE -$nfhrs $CDATE `
    fymd=`echo $fymdh | cut -c1-8`
    fcyc=`echo $fymdh | cut -c9-10`

  fi

  COMANL=$NGLOBAL/Bo.Cui/com/gens/prod/gefs.${aymd}/${acyc}/pgrba
  COMA=$NGLOBAL/Bo.Cui/com/gens/prod

  if [ "$IF_ECMWFANL" = "YES" ]; then
    COMANL=$NGLOBAL/Bo.Cui/com/gens/wcoss/ecmwf.${aymd}/${acyc}/pgrba
    afile1=ecmwf_gegfs.t${acyc}z.pgrbaf00
  elif [ "$IF_NCEPANL" = "YES" ]; then
    COMANL=$NGLOBAL/Bo.Cui/com/gens/prod/gefs.${aymd}/${acyc}/pgrba
    afile1=gec00.t${acyc}z.pgrbaf00
  fi

  case $cfield in
    TMAX) COMANL=$COMA/gefs.${aymd_m06}/${acyc_m06}/pgrba;;
    TMIN) COMANL=$COMA/gefs.${aymd_m06}/${acyc_m06}/pgrba;;
  esac


  case $cfield in
    TMAX) afile1=gec00.t${acyc_m06}z.pgrbaf06;;
    TMIN) afile1=gec00.t${acyc_m06}z.pgrbaf06;;
  esac

  if [ -s $afile1 ]; then rm $afile1; fi

  cp $COMANL/$afile1 .

  if [ -s $afile1 ]; then
    echo " "
  else
    echo " There is no NCEP analysis data, Stop! for " $aymdh
  fi

###
# climate mean file entry
###

  afile2=cmean_1d.1979$amd
# cp $COMCLIM/$afile2 .

  cp $COMCLIM/${afile2} ${afile2}

  if [ -s $afile2 ]; then
    echo " "
  else
    echo " There is no climate mean data, Stop! for " $aymdh
  fi

###
# Center 1: NCEP forecast files entry, ensembel average, ensemble spread
###

  COMFCST1=$COM_NCEP/${id1}.${fymd}/${fcyc}/pgrba$ex

  cfile1=$COMFCST1/${px1}geavg.t${fcyc}z.pgrba${ex}f${nfhrs}
  cfile2=$COMFCST1/${px1}gespr.t${fcyc}z.pgrba${ex}f${nfhrs}

###
# Center 2: CMC forecast files entry, ensembel average, ensemble spread
###

  COMFCST2=$COM_CMC/${id2}.${fymd}/${fcyc}/pgrba$ex

  cfile3=$COMFCST2/${px2}geavg.t${fcyc}z.pgrba${ex}f${nfhrs}
  cfile4=$COMFCST2/${px2}gespr.t${fcyc}z.pgrba${ex}f${nfhrs}

# CMC and NCEP analysis difference input, first step is to judge valid time

  if [ "$IFDEBIAS_CMC" = "YES" ]; then 

    ymdh=${fymd}${fcyc}
    export PDYm1=`$NDATE -24 $ymdh | cut -c1-8`
    export PDYm2=`$NDATE -48 $ymdh | cut -c1-8`
    export PDYm3=`$NDATE -72 $ymdh | cut -c1-8`
    export PDYm4=`$NDATE -96 $ymdh | cut -c1-8`

    cyc_verf=`$NDATE +$nfhrs $ymdh | cut -c9-10`

    bfile1=ncepcmc_glbanl.t${cyc_verf}z.pgrba_mdf00

    if [ -s $bfile1 ]; then rm $bfile1; fi

    if [ -s $COM_NCEP/gefs.$PDYm2/${cyc_verf}/pgrba/$bfile1 ]; then
      cp $COM_NCEP/gefs.$PDYm2/${cyc_verf}/pgrba/$bfile1  .
    elif [ -s $COM_NCEP/gefs.$PDYm3/${cyc_verf}/pgrba/$bfile1 ]; then
      cp $COM_NCEP/gefs.$PDYm3/${cyc_verf}/pgrba/$bfile1  .
    elif [ -s $COM_NCEP/gefs.$PDYm4/${cyc_verf}/pgrba/$bfile1 ]; then
      cp $COM_NCEP/gefs.$PDYm4/${cyc_verf}/pgrba/$bfile1  .
    elif [ -s $COM_NCEP/gefs.$PDYm5/${cyc_verf}/pgrba/$bfile1 ]; then
      cp $COM_NCEP/gefs.$PDYm5/${cyc_verf}/pgrba/$bfile1  .
    elif [ -s $COM_NCEP/gefs.$PDYm6/${cyc_verf}/pgrba/$bfile1 ]; then
      cp $COM_NCEP/gefs.$PDYm6/${cyc_verf}/pgrba/$bfile1  .
    elif [ -s $COM_NCEP/gefs.$PDYm7/${cyc_verf}/pgrba/$bfile1 ]; then
      cp $COM_NCEP/gefs.$PDYm7/${cyc_verf}/pgrba/$bfile1  .
    fi

  fi

###
# Center 3: forecast files entry, ensembel average, ensemble spread
###

  COMFCST3=$COM_ECMWF/${id3}.${fymd}/${fcyc}/pgrba$ex

  cfile5=$COMFCST3/${px3}geavg.t${fcyc}z.pgrba${ex}f${nfhrs}
  cfile6=$COMFCST3/${px3}gespr.t${fcyc}z.pgrba${ex}f${nfhrs}

# ECMWF and NCEP analysis difference input, first step is to judge valid time

  if [ "$IFDEBIAS_ECMWF" = "YES" ]; then 

    ymdh=${fymd}${fcyc}
    export PDYm1=`$NDATE -24 $ymdh | cut -c1-8`
    export PDYm2=`$NDATE -48 $ymdh | cut -c1-8`
    export PDYm3=`$NDATE -72 $ymdh | cut -c1-8`
    export PDYm4=`$NDATE -96 $ymdh | cut -c1-8`

    cyc_verf=`$NDATE +$nfhrs $ymdh | cut -c9-10`

    bfile2=ncepecmwf_glbanl.t${cyc_verf}z.pgrba_mdf00

    if [ -s $bfile2 ]; then rm $bfile2; fi

    if [ -s $COM_ECMWF/gefs.$PDYm2/${cyc_verf}/pgrba/$bfile2 ]; then
      cp $COM_ECMWF/gefs.$PDYm2/${cyc_verf}/pgrba/$bfile2  .
    elif [ -s $COM_ECMWF/gefs.$PDYm3/${cyc_verf}/pgrba/$bfile2 ]; then
      cp $COM_ECMWF/gefs.$PDYm3/${cyc_verf}/pgrba/$bfile2  .
    elif [ -s $COM_ECMWF/gefs.$PDYm4/${cyc_verf}/pgrba/$bfile2 ]; then
      cp $COM_ECMWF/gefs.$PDYm4/${cyc_verf}/pgrba/$bfile2  .
    elif [ -s $COM_ECMWF/gefs.$PDYm5/${cyc_verf}/pgrba/$bfile2 ]; then
      cp $COM_ECMWF/gefs.$PDYm5/${cyc_verf}/pgrba/$bfile2  .
    elif [ -s $COM_ECMWF/gefs.$PDYm6/${cyc_verf}/pgrba/$bfile2 ]; then
      cp $COM_ECMWF/gefs.$PDYm6/${cyc_verf}/pgrba/$bfile2  .
    elif [ -s $COM_ECMWF/gefs.$PDYm7/${cyc_verf}/pgrba/$bfile2 ]; then
      cp $COM_ECMWF/gefs.$PDYm7/${cyc_verf}/pgrba/$bfile2  .
    fi

  fi

###
#  output verified results                    
###

  ofile=crps.t${fcyc}z.pgrbaf${nfhrs}_$cfield
 
  echo "&message"  >input.$nfhrs.$cfield
  echo " nfhrs=$nfhrs," >>input.$nfhrs.$cfield
  echo " odate=$aymdh," >>input.$nfhrs.$cfield

  if [ "$runini" = "YES" ]; then
    echo " idate=$CDATE," >>input.$nfhrs.$cfield
  else
    echo " idate=$fymdh," >>input.$nfhrs.$cfield
  fi

  echo " variable='$cfield',"           >>input.$nfhrs.$cfield
  echo " ifncep=$ifncep,"               >>input.$nfhrs.$cfield
  echo " ifcmc=$ifcmc,"                 >>input.$nfhrs.$cfield
  echo " ifecmwf=$ifecmwf,"               >>input.$nfhrs.$cfield
  echo " ifdebias_cmc=$ifdebias_cmc,"     >>input.$nfhrs.$cfield
  echo " ifdebias_ecmwf=$ifdebias_ecmwf," >>input.$nfhrs.$cfield

  echo "/" >>input.$nfhrs.$cfield
  
  cat namin.varlist.$cfield >>input.$nfhrs.$cfield

  cat input.domlist >>input.$nfhrs.$cfield

  ln -sf $afile1 fort.11
  ln -sf $afile2 fort.12

  if [ "$IFNCEP" = "YES" ]; then 
    ln -sf $cfile1 fort.13
    ln -sf $cfile2 fort.14
  fi

  if [ "$IFCMC" = "YES" ]; then
    ln -sf $cfile3 fort.15
    ln -sf $cfile4 fort.16
    if [ "$IFDEBIAS_CMC" = "YES" ]; then 
      ln -sf $bfile1 fort.21
    fi
  fi

  if [ "$IFECMWF" = "YES" ]; then
    ln -sf $cfile5 fort.17
    ln -sf $cfile6 fort.18
    if [ "$IFDEBIAS_ECMWF" = "YES" ]; then 
      ln -sf $bfile2 fort.22
    fi
  fi

  ln -sf $ofile  fort.51

# startmsg
  $EXECVERF/$pgm  <input.$nfhrs.$cfield > $pgmout.${nfhrs}_$cfield
# export err=$?;err_chk

  if [ -s $ofile ]; then cat $ofile >> SCORES.OUT.${cfield}; fi

done # for fhrs

if [ "$runini" = "YES" ]; then
 cp SCORES.OUT.${cfield} $COMOUT/P${cfield}${ENSIM}f.$CDATE
fi

if [ "$runini" = "NO" ]; then
 cp SCORES.OUT.${cfield} $COMOUT/P${cfield}${ENSIM}a.$CDATE
fi

done  # for cfield

msg="HAS COMPLETED NORMALLY!"
#postmsg "$jlogfile" "$msg"

###
#
